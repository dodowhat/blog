<!DOCTYPE html>


<html lang="zh" data-theme="">
<head>
    
        
<meta charset="utf-8">
<meta name="HandheldFriendly" content="True">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer-when-downgrade">

<title>Linux 系统 Clash 服务管理 - 纸上谈兵</title>
<meta name="description" content="">

<link rel="icon" type="image/x-icon" href="/blog/favicon.ico">
<link rel="apple-touch-icon-precomposed" href="/blog/favicon.png">

<link rel="stylesheet" href="/blog/css/light.css?rnd=1605029419" />
<style>

    [data-theme="dark"] {   
        --font-color: #eee;
--bg-color: #212121;

--link-color:#599ada;
--link-state-color:#ff5858;
--link-state-border-color: rgba(238, 54, 54, 0.5);

--thead-bg-color: #343a40;
--table-border-color: lightgrey;

--pre-color: #333;
--pre-bg-color: #f1f1f1;

--bq-color: #ccc;
--hr-color: #333;

--pagination-bg-color: #373737;
--pagination-link-color: #b6b6b6;

--post-info-color: grey;

--switcher-color: #333;
--switcher-bg-color: #fff;

    }

</style>

<link rel="stylesheet" href="/blog/css/style.css?rnd=1605029419" />





<meta property="og:title" content="Linux 系统 Clash 服务管理" />
<meta property="og:description" content="Clash 是一款支持多种协议的代理客户端，在 Windows 以及 MacOS 上均有图形化版本，然而 Linux 上没有。 好在 Clash 提供了用于管理服务的 RESTful API ，并且作者开发了配套的 Web 版管理面板" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/blog/posts/clash-service-management-on-linux/" />
<meta property="article:published_time" content="2020-11-06T20:45:17+08:00" />
<meta property="article:modified_time" content="2020-11-06T20:45:17+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Linux 系统 Clash 服务管理"/>
<meta name="twitter:description" content="Clash 是一款支持多种协议的代理客户端，在 Windows 以及 MacOS 上均有图形化版本，然而 Linux 上没有。 好在 Clash 提供了用于管理服务的 RESTful API ，并且作者开发了配套的 Web 版管理面板"/>








    
</head>
<body>
    <a class="skip-main" href="#main">Skip to main content</a>
    <div class="container">
        <header class="common-header"> 
            
                <h1 class="site-title">
    <a href="/blog">纸上谈兵</a>
</h1>
<nav>
    
    
</nav>

            
        </header>
        <main id="main" tabindex="-1"> 
            
    
    
    <article class="post">
        <header class="post-header">
            <h1 class="post-title">Linux 系统 Clash 服务管理</h1>
        </header>
        <div class="content">
            <p>Clash 是一款支持多种协议的代理客户端，在 Windows 以及 MacOS 上均有图形化版本，然而 Linux 上没有。</p>
<p>好在 Clash 提供了用于管理服务的 RESTful API ，并且作者开发了配套的 Web 版管理面板，其他人也可以根据 API 开发自己的管理面板。</p>
<p>本文记录了如何在 Linux 系统上丝滑地使用 Clash 服务。</p>
<h2 id="准备工作">准备工作</h2>
<p>访问 <a href="https://github.com/Dreamacro/clash/releases">Clash Github Releases</a>，找到适合自己硬件架构的版本，一般为 clash-linux-amd64。</p>
<p>命令行操作：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># 创建一个工作目录</span>
$ mkdir clash-linux-management-tools
$ cd clash-linux-management-tools
<span style="color:#75715e"># 下载</span>
$ wget https://github.com/Dreamacro/clash/releases/download/v1.2.0/clash-linux-amd64-v1.2.0.gz
<span style="color:#75715e"># 解压</span>
$ gzip -d clash-linux-amd64-v1.2.0.gz
<span style="color:#75715e"># 解压出来程序的文件名带有平台、版本等信息，重命名为 clash 方便执行</span>
$ mv clash-linux-amd64-v1.2.0 clash
<span style="color:#75715e"># 赋予程序可执行权限</span>
$ chmod u+x clash
</code></pre></div><h2 id="后台运行">后台运行</h2>
<p>Clash 本身不提供后台服务运行的功能，需要用户自己想办法，大致有三种实现方式：</p>
<ul>
<li>Systemd (官方 Gihub Wiki 有具体教程)</li>
</ul>
<blockquote>
<p>通过创建 Systemd 配置文件将 Clash 纳入系统进程管理</p>
</blockquote>
<ul>
<li>第三方进程管理工具</li>
</ul>
<blockquote>
<p>常见的有：<a href="https://pm2.keymetrics.io/">pm2</a> <a href="https://nodemon.io/">nodemon</a></p>
</blockquote>
<ul>
<li>Shell 命令</li>
</ul>
<blockquote>
<p>利用 nohup 命令以及其它进程管理命令实现后台运行</p>
</blockquote>
<p>个人不喜欢前两种方式，所以选择第三种方式。</p>
<p>启动服务脚本 start.sh</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>
<span style="color:#75715e"># 检测并结束正在运行的 Clash 服务，下面会讲到</span>
./stop.sh

<span style="color:#75715e"># 启动服务</span>
nohup ./clash -d . &gt; /dev/null 2&gt;&amp;<span style="color:#ae81ff">1</span> &amp;
</code></pre></div><p>启动命令有三部分，简单说明一下</p>
<ul>
<li>nohup</li>
</ul>
<blockquote>
<p>这个命令可以让你执行的程序忽略“挂起”信号。
也就是说假如你通过它运行了某个程序，然后关掉了终端窗口，这个程序依旧会在系统里运行。
使用方法为在你执行的命令最前面加上 nohup 就可以了。</p>
</blockquote>
<ul>
<li>./clash -d .</li>
</ul>
<blockquote>
<p>这是普通方式启动 Clash 的命令。
-d 参数可以指定配置文件所在的目录，这里我指定为当前所在目录，所以写一个 . 就可以了。
特别说明一下配置文件名称必须为 config.yaml，否则程序不会识别。</p>
</blockquote>
<p>或者也可以用 -f 参数指定配置文件，文件名无要求。</p>
<ul>
<li>&gt; /dev/null 2&gt;&amp;1 &amp;</li>
</ul>
<blockquote>
<p>这部分用一句话概括就是“保持静默地在后台运行”，在搜索 nohup 相关资料时应该会有提及，这里就不赘述了。</p>
</blockquote>
<p>结束服务脚本 stop.sh</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>
<span style="color:#75715e"># 查找 clash 服务的进程ID</span>
PID<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>pidof clash<span style="color:#66d9ef">)</span>

<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> ! -z <span style="color:#e6db74">&#34;</span>$PID<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    <span style="color:#75715e"># 根据进程ID结束进程</span>
    kill -9 $PID
<span style="color:#66d9ef">fi</span>
</code></pre></div><p>好了，现在就可以通过脚来启动或结束服务了。</p>
<p>接下来看如何管理“机场”订阅的配置文件。</p>
<h2 id="订阅配置管理">订阅配置管理</h2>
<p>如今网络上有很多提供代理服务的商家 (俗称“机场”)，订阅之后会向你提供一个链接用来下载配置文件。</p>
<p>图形化版本的 Clash 可以很方便地通过鼠标点点点来管理这些订阅配置，那么如何通过命令行来做到这些呢？</p>
<p>首先我们创建一个目录，用来存放下载后的订阅配置文件</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ mkdir configs
</code></pre></div><p>接着创建订阅配置管理脚本，假如某“机场”名叫 &ldquo;abc&rdquo; ，创建 abc.sh (名字可以随便起)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>
<span style="color:#75715e"># 这里填你的订阅链接</span>
URL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://abc.xyz/user123/clash&#34;</span>

FILENAME<span style="color:#f92672">=</span>configs/<span style="color:#66d9ef">$(</span>basename $0 .sh<span style="color:#66d9ef">)</span>.yaml

curl -L <span style="color:#e6db74">${</span>URL<span style="color:#e6db74">}</span> &gt; <span style="color:#e6db74">${</span>FILENAME<span style="color:#e6db74">}</span>

<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $? -eq <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    cp <span style="color:#e6db74">${</span>FILENAME<span style="color:#e6db74">}</span> config.yaml
<span style="color:#66d9ef">fi</span>;
</code></pre></div><p>执行这个脚本后会在 configs 目录下生成 abc.yaml (与脚本名称自动保持一致) 并且覆盖到 config.yaml 作为默认配置。</p>
<p>如果你还有其它的订阅链接，将这份脚本复制一份，改个文件名 (比如 def.sh)，再修改里面的 URL 就可以使用了。</p>
<h2 id="半场总结">半场总结</h2>
<p>现在我们回顾一下当前工作目录的文件结构</p>
<pre><code>|clash-linux-management-tools
    |---- clash          解压并重命名的 clash 本体
    |---- config.yaml    默认配置文件
    |---- start.sh       启动/重启脚本
    |---- stop.sh        结束运行脚本
    |---- abc.sh         abc订阅更新脚本
    |---- def.sh         def订阅更新脚本
    |==== configs        订阅配置下载目录
        |---- abc.yaml   下载的abc订阅配置
        |---- def.yaml   下载的def订阅配置
</code></pre>
<p>接下来部署 Web 管理面板。</p>
<h2 id="部署-web-管理面板">部署 Web 管理面板</h2>
<p>Web 管理面板有两个版本</p>
<ul>
<li>
<p><a href="https://github.com/Dreamacro/clash-dashboard">clash-dashboard</a> 由 Clash 作者开发</p>
</li>
<li>
<p><a href="https://github.com/haishanh/yacd">yacd</a> 由第三方作者开发</p>
</li>
</ul>
<p>两个项目的 gh-pages 分支均为编译好的成品，可直接部署使用。</p>
<p>以 yacd 为例，clone 项目，切换分支</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ git clone https://github.com/haishanh/yacd ~/yacd
$ cd ~/yacd
$ git fetch
$ git checkout gh-pages
</code></pre></div><p>安装 Nginx (以 Ubuntu 系统为例)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo apt install nginx
</code></pre></div><p>创建配置 /etc/nginx/sites-available/yacd.conf</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nginx" data-lang="nginx"><span style="color:#66d9ef">server</span> {
	<span style="color:#f92672">listen</span> <span style="color:#ae81ff">9090</span>;

	<span style="color:#f92672">server_name</span> <span style="color:#e6db74">_</span>;

	<span style="color:#f92672">root</span> <span style="color:#e6db74">/home/xxx/yacd</span>;
	<span style="color:#f92672">index</span> <span style="color:#e6db74">index.html</span>;

	<span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
		<span style="color:#f92672">try_files</span> $uri $uri/ =<span style="color:#ae81ff">404</span>;
	}
}
</code></pre></div><p>启用配置，启动服务</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo ln -s /etc/nginx/sites-available/yacd.conf /etc/nginx/sites-enabled/
$ sudo nginx
</code></pre></div><p>然后就可以访问 http://localhost:9090 使用了</p>
<h2 id="订阅更新脚本在-wsl2-上的一些调整">订阅更新脚本在 WSL2 上的一些调整</h2>
<p>WSL2 与 Windows 10 宿主系统共用端口，运行 Clash 服务时需要更改相应的端口。</p>
<p>(实测不改端口也能各自使用，但偶尔会影响 Windows 版 Clash 正常工作，具体原因不明。
猜测为：微软做了一些工作使得运行在 WSL2 上的服务可通过 localhost 访问，但此功能时好时坏，应该和这个有关。)</p>
<p>因此订阅配置更新脚本需要做一些修改，使更新后的配置文件自动替换为指定端口</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>
URL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://abc.xyz/user123/clash&#34;</span>

FILENAME<span style="color:#f92672">=</span>configs/<span style="color:#66d9ef">$(</span>basename $0 .sh<span style="color:#66d9ef">)</span>.yaml

curl -L <span style="color:#e6db74">${</span>URL<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    | tac | tac <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    | sed -e <span style="color:#e6db74">&#39;s/^port: [0-9]*/port: 7900/&#39;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -e <span style="color:#e6db74">&#39;s/^socks-port: [0-9]*/socks-port: 7901/&#39;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -e <span style="color:#e6db74">&#39;s/^external-controller: [0-9\.\:]*/external-controller: 127.0.0.1:9010/&#39;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    &gt; <span style="color:#e6db74">${</span>FILENAME<span style="color:#e6db74">}</span>

<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $? -eq <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    cp <span style="color:#e6db74">${</span>FILENAME<span style="color:#e6db74">}</span> config.yaml
<span style="color:#66d9ef">fi</span>;
</code></pre></div>
        </div>
        


<div class="post-info">
    
        <div class="post-date">2020-11-06</div>
    
    <div class="post-taxonomies">
        
            
    </div>
</div>

    </article>

    

    


        </main>
        
            <footer class="common-footer">
    
    

     

    <div class="common-footer-bottom">
        <div class="copyright">
            <p>© 2020<br>
            Powered by <a target="_blank" rel="noopener noreferrer" href="https://gohugo.io/">Hugo</a>, theme <a target="_blank" rel="noopener noreferrer" href="https://github.com/mitrichius/hugo-theme-anubis">Anubis</a>.
            </p>  
        </div> 

        


   
    </div>

</footer>

        
    </div>
</body>
</html>

<!DOCTYPE html>
<html>
  <head>
    
    
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>
      
  Linux 系统 Clash 服务管理 &ndash; 温故知新

    </title>
    
    
    <meta name="description" property="og:description" content="Clash 是一款支持多种协议的代理客户端，在 Windows 以及 MacOS 上均有图形化版本，然而 Linux 上没有。 好在 Clash 提供了用于管理服务的 RESTful API ，并且作者开发了配套的 Web 版管理面板|">
    

    <meta name="apple-mobile-web-app-title" content="温故知新">
    
    
    <link rel="icon" href="/favicon-64.png">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="mask-icon" size="any" href="/pinned-icon.svg">
    
    
    


    <link rel="stylesheet" href="/blog/assets/syntax.css">
    <link rel="stylesheet" href="/blog/assets/primer-build.css">
    <link rel="stylesheet" href="/blog/assets/style.css">
    <link rel="stylesheet" href="/blog/assets/custom_style.css">
  </head>


  <body class="bg-gray">
    <div id="holy" class="container-lg bg-white h-100">

      <div id="header" class="px-1 bg-white">
        <nav class="UnderlineNav UnderlineNav--right px-2">
  <a class="UnderlineNav-actions muted-link h2" href="https://dodowhat.github.io/blog/">
    温故知新
  </a>

  
  
</nav>

      </div>

      <div role="main" id="main" class="holy-main markdown-body px-4 bg-white">
        

<div class="Subhead">
  <div class="Subhead-heading">
    <div class="h1 mt-3 mb-1">Linux 系统 Clash 服务管理</div>
  </div>
  <div class="Subhead-description">
    






    
    <div class="float-md-right">
      <span title="Lastmod: 2020-11-06. Published at: 2020-11-06.">
        
          Published: 2020-11-06
        
      </span>
    </div>
    
  </div>
</div>
<article>
  
  <section class="pb-6 mb-3 border-bottom">
    <p>Clash 是一款支持多种协议的代理客户端，在 Windows 以及 MacOS 上均有图形化版本，然而 Linux 上没有。</p>
<p>好在 Clash 提供了用于管理服务的 RESTful API ，并且作者开发了配套的 Web 版管理面板，其他人也可以根据 API 开发自己的管理面板。</p>
<p>本文记录了如何在 Linux 系统上丝滑地使用 Clash 服务。</p>
<p>(本文内容包含的脚本相对粗糙，是为了降低复杂度说清原理而简化的原始版本，完全版已上传至 Github 仓库 <a href="https://github.com/dodowhat/clash-for-linux">clash-for-linux</a> ，功能更完善)</p>
<h2 id="准备工作">准备工作</h2>
<p>访问 <a href="https://github.com/Dreamacro/clash/releases">Clash Github Releases</a>，找到适合自己硬件架构的版本，一般为 clash-linux-amd64。</p>
<p>命令行操作：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 创建一个工作目录</span>
$ mkdir clash-linux-management-tools
$ <span class="nb">cd</span> clash-linux-management-tools
<span class="c1"># 下载</span>
$ wget https://github.com/Dreamacro/clash/releases/download/v1.2.0/clash-linux-amd64-v1.2.0.gz
<span class="c1"># 解压</span>
$ gzip -d clash-linux-amd64-v1.2.0.gz
<span class="c1"># 解压出来程序的文件名带有平台、版本等信息，重命名为 clash 方便执行</span>
$ mv clash-linux-amd64-v1.2.0 clash
<span class="c1"># 赋予程序可执行权限</span>
$ chmod u+x clash
</code></pre></div><h2 id="后台运行">后台运行</h2>
<p>Clash 本身不提供后台服务运行的功能，需要用户自己想办法，大致有三种实现方式：</p>
<ul>
<li>Systemd (官方 Gihub Wiki 有具体教程)</li>
</ul>
<blockquote>
<p>通过创建 Systemd 配置文件将 Clash 纳入系统进程管理</p>
</blockquote>
<ul>
<li>第三方进程管理工具</li>
</ul>
<blockquote>
<p>常见的有：<a href="https://pm2.keymetrics.io/">pm2</a> <a href="https://nodemon.io/">nodemon</a></p>
</blockquote>
<ul>
<li>Shell 命令</li>
</ul>
<blockquote>
<p>利用 nohup 命令以及其它进程管理命令实现后台运行</p>
</blockquote>
<p>个人不喜欢前两种方式，所以选择第三种方式。</p>
<p>启动服务脚本 start.sh</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!/bin/bash
</span><span class="cp"></span>
<span class="c1"># 检测并结束正在运行的 Clash 服务，下面会讲到</span>
./stop.sh

<span class="c1"># 启动服务</span>
nohup ./clash -d . &gt; /dev/null 2&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">&amp;</span>
</code></pre></div><p>启动命令有三部分，简单说明一下</p>
<ul>
<li>nohup</li>
</ul>
<blockquote>
<p>这个命令可以让你执行的程序忽略“挂起”信号。
也就是说假如你通过它运行了某个程序，然后关掉了终端窗口，这个程序依旧会在系统里运行。
使用方法为在你执行的命令最前面加上 nohup 就可以了。</p>
</blockquote>
<ul>
<li>./clash -d .</li>
</ul>
<blockquote>
<p>这是普通方式启动 Clash 的命令。
-d 参数可以指定配置文件所在的目录，这里我指定为当前所在目录，所以写一个 . 就可以了。
特别说明一下配置文件名称必须为 config.yaml，否则程序不会识别。</p>
</blockquote>
<p>或者也可以用 -f 参数指定配置文件，文件名无要求。</p>
<ul>
<li>&gt; /dev/null 2&gt;&amp;1 &amp;</li>
</ul>
<blockquote>
<p>这部分用一句话概括就是“保持静默地在后台运行”，在搜索 nohup 相关资料时应该会有提及，这里就不赘述了。</p>
</blockquote>
<p>结束服务脚本 stop.sh</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!/bin/bash
</span><span class="cp"></span>
<span class="c1"># 查找 clash 服务的进程ID</span>
<span class="nv">PID</span><span class="o">=</span><span class="k">$(</span>pidof clash<span class="k">)</span>

<span class="k">if</span> <span class="o">[</span> ! -z <span class="s2">&#34;</span><span class="nv">$PID</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="c1"># 根据进程ID结束进程</span>
    <span class="nb">kill</span> -9 <span class="nv">$PID</span>
<span class="k">fi</span>
</code></pre></div><p>好了，现在就可以通过脚来启动或结束服务了。</p>
<p>接下来看如何管理“机场”订阅的配置文件。</p>
<h2 id="订阅配置管理">订阅配置管理</h2>
<p>如今网络上有很多提供代理服务的商家 (俗称“机场”)，订阅之后会向你提供一个链接用来下载配置文件。</p>
<p>图形化版本的 Clash 可以很方便地通过鼠标点点点来管理这些订阅配置，那么如何通过命令行来做到这些呢？</p>
<p>首先我们创建一个目录，用来存放下载后的订阅配置文件</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ mkdir configs
</code></pre></div><p>接着创建订阅配置管理脚本，假如某“机场”名叫 &ldquo;abc&rdquo; ，创建 abc.sh (名字可以随便起)</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!/bin/bash
</span><span class="cp"></span>
<span class="c1"># 这里填你的订阅链接</span>
<span class="nv">URL</span><span class="o">=</span><span class="s2">&#34;https://abc.xyz/user123/clash&#34;</span>

<span class="nv">FILENAME</span><span class="o">=</span>configs/<span class="k">$(</span>basename <span class="nv">$0</span> .sh<span class="k">)</span>.yaml

curl -L <span class="si">${</span><span class="nv">URL</span><span class="si">}</span> &gt; <span class="si">${</span><span class="nv">FILENAME</span><span class="si">}</span>

<span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    cp <span class="si">${</span><span class="nv">FILENAME</span><span class="si">}</span> config.yaml
<span class="k">fi</span><span class="p">;</span>
</code></pre></div><p>执行这个脚本后会在 configs 目录下生成 abc.yaml (与脚本名称自动保持一致) 并且覆盖到 config.yaml 作为默认配置。</p>
<p>如果你还有其它的订阅链接，将这份脚本复制一份，改个文件名 (比如 def.sh)，再修改里面的 URL 就可以使用了。</p>
<h2 id="半场总结">半场总结</h2>
<p>现在我们回顾一下当前工作目录的文件结构</p>
<pre><code>|clash-linux-management-tools
    |---- clash          解压并重命名的 clash 本体
    |---- config.yaml    默认配置文件
    |---- start.sh       启动/重启脚本
    |---- stop.sh        结束运行脚本
    |---- abc.sh         abc订阅更新脚本
    |---- def.sh         def订阅更新脚本
    |==== configs        订阅配置下载目录
        |---- abc.yaml   下载的abc订阅配置
        |---- def.yaml   下载的def订阅配置
</code></pre>
<p>接下来部署 Web 管理面板。</p>
<h2 id="部署-web-管理面板">部署 Web 管理面板</h2>
<p>Web 管理面板有两个版本</p>
<ul>
<li>
<p><a href="https://github.com/Dreamacro/clash-dashboard">clash-dashboard</a> 由 Clash 作者开发</p>
</li>
<li>
<p><a href="https://github.com/haishanh/yacd">yacd</a> 由第三方作者开发</p>
</li>
</ul>
<p>两个项目的 gh-pages 分支均为编译好的成品，可直接部署使用。</p>
<p>以 yacd 为例</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 下载</span>
$ curl -L https://github.com/haishanh/yacd/archive/gh-pages.zip --output yacd-gh-pages.zip

<span class="c1"># 解压并重命名</span>
unzip yacd-gh-pages.zip
mv yacd-gh-pages ui
</code></pre></div><p>然后修改 start.sh</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 启动服务</span>
nohup ./clash -d . -ext-ctl 127.0.0.1:9090 -ext-ui ui &gt; /dev/null 2&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">&amp;</span>
</code></pre></div><p>然后就可以访问 http://127.0.0.1:9090/ui 使用了</p>

  </section>

  <section>
    
      
    
  </section>
</article>

      </div>

      <div id="side" class="pr-1 bg-white">
        <aside class="pr-3">
          
  
    <div id="toc" class="Box Box--blue mb-3">
      <b>Linux 系统 Clash 服务管理</b><nav id="TableOfContents">
  <ul>
    <li><a href="#准备工作">准备工作</a></li>
    <li><a href="#后台运行">后台运行</a></li>
    <li><a href="#订阅配置管理">订阅配置管理</a></li>
    <li><a href="#半场总结">半场总结</a></li>
    <li><a href="#部署-web-管理面板">部署 Web 管理面板</a></li>
  </ul>
</nav></div>
  

  
    <div>
      
    </div>
  

        </aside>
      </div>

      <div id="footer" class="pt-2 pb-3 bg-white text-center">
        

  <span class="text-small text-gray">
    

    Powered by the
    <a href="https://github.com/qqhann/hugo-primer" class="link-gray-dark">Hugo-Primer</a> theme for
    <a href="https://gohugo.io" class="link-gray-dark">Hugo</a>.
  </span>


      </div>
    </div>

    
    
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>
    
  </body>
</html>
